<!doctype html>
<html>
<body>
<p>Goal: I want to custom format javascript object by wrapping it in my formatting and deferring to the system formatter at some point. See example naiveSelfReferenceWrappingFormatter.</p>
<p>Problem: I have no API to invoke system formatter in JSON ML, the only mechanism is object reference which lead to infinite recursion.</p>
<p>Possible solution: Object references should not re-enter the same formatter with the same object.
  JSON ML renderer should keep track of all invoked formatter-object pairs as it dives into recursion
  and simply skip formatters which would be re-enter given formatter with the same object.</p>
<script>
  var trouble = {"this is": "a troublesome object"};

  var naiveSelfReferenceWrappingFormatter = {
    header: function(o) {
      if (o === trouble) {
        return ["span", {"style": "background-color:#f00;color:white"}, "Reference original object in header <", ["object", {"object": o, "style": "color:green"}, "TROUBLE"], ">"];
      }
    },
    hasBody: function(o) {
      return false;
    },
    body: function(o) {
      return nil;
    }
  };

  var ignored = [];
  var workaroundSelfReferenceWrappingFormatter = {
    header: function(o) {
      var index = ignored.indexOf(o);
      if (index == -1) {
        if (o === trouble) {
          ignored.push(o);
          return ["span", {"style": "background-color:#f00;color:white"}, "Reference original object in header <", ["object", {"object": o, "style": "color:green"}, "TROUBLE"], ">"];
        }
      } else {
        ignored.splice(index, 1);
      }
    },
    hasBody: function(o) {
      return false;
    },
    body: function(o) {
      return nil;
    }
  };

  window.devtoolsFormatters = [naiveSelfReferenceWrappingFormatter];
  // uncommenting this will cause infinite loop in header expansion (that is expected) and browser stall (that is unexpected)
  // console.log(trouble);

  // we can work around it (chrome CF implementation dependent)
  window.devtoolsFormatters = [workaroundSelfReferenceWrappingFormatter];
  console.log(trouble);
</script>
</body>
</html>
